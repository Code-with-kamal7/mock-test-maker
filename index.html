<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Test Maker Pro by Kamal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --bg: #f8fafc;
            --bg-secondary: #f1f5f9;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.15);
            --shadow-lg: 0 20px 60px -15px rgba(99, 102, 241, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="2" fill="white" opacity="0.1"/></svg>');
            animation: float 20s linear infinite;
        }

        @keyframes float {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100px); }
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            position: relative;
            text-shadow: 0 2px 20px rgba(0,0,0,0.2);
        }

        .hero p {
            font-size: 1.3rem;
            opacity: 0.95;
            margin-bottom: 40px;
            position: relative;
        }

        .hero-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.5);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Cards */
        .card {
            background: var(--card);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            background: var(--card);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* Test Interface */
        .test-header {
            background: white;
            border-bottom: 2px solid var(--border);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .test-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .timer {
            font-size: 2rem;
            font-weight: 800;
            color: var(--danger);
            font-variant-numeric: tabular-nums;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .test-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
            margin-top: 24px;
        }

        @media (max-width: 1024px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Question Card */
        .question-card {
            background: white;
            padding: 35px;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg);
        }

        .topic-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .question-counter {
            font-weight: 700;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            line-height: 1.7;
            margin-bottom: 30px;
            color: var(--text-main);
        }

        /* Options */
        .option {
            padding: 18px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .option:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f5f3ff 0%, #faf5ff 100%);
            transform: translateX(5px);
        }

        .option.selected {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .option-label {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .option.selected .option-label {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Palette */
        .palette-card {
            position: sticky;
            top: 100px;
        }

        .palette {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .palette-btn {
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 2px solid var(--border);
            cursor: pointer;
            font-weight: 700;
            background: white;
            transition: all 0.3s ease;
            position: relative;
        }

        .palette-btn:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .palette-btn.answered {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .palette-btn.marked {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .palette-btn.current {
            border: 3px solid var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            transform: scale(1.1);
        }

        .palette-btn.unanswered {
            background: #fee2e2;
            color: var(--danger);
            border-color: #fecaca;
        }

        .palette-legend {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            color: white;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Results */
        .result-section {
            max-width: 1000px;
            margin: 0 auto;
        }

        .review-card {
            margin-bottom: 20px;
            padding: 25px;
            border-radius: 12px;
            background: white;
            border-left: 6px solid var(--border);
        }

        .review-card.correct {
            border-left-color: var(--success);
            background: linear-gradient(to right, #f0fdf4 0%, white 100%);
        }

        .review-card.wrong {
            border-left-color: var(--danger);
            background: linear-gradient(to right, #fef2f2 0%, white 100%);
        }

        .review-card.skipped {
            border-left-color: var(--text-muted);
            background: linear-gradient(to right, #f8fafc 0%, white 100%);
        }

        /* Overlay */
        #overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* History Cards */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .history-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2rem; }
            .hero p { font-size: 1rem; }
            .test-header { padding: 15px 0; }
            .timer { font-size: 1.5rem; }
            .palette { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="overlay" class="hidden">
        <div class="loader"></div>
        <h2 id="overlay-title" style="margin-top: 30px; color: var(--text-main);">Processing...</h2>
        <p id="overlay-text" style="color: var(--text-muted); margin-top: 10px;"></p>
    </div>

    <!-- Home Page -->
    <section id="page-home" class="page">
        <div class="hero">
            <h1>üéØ Mock Test Maker Pro</h1>
            <p>Ultimate Exam Preparation Platform for Government Exams</p>
            <div class="hero-buttons">
                <button class="btn btn-primary" onclick="showPage('page-setup')">
                    ‚ö° AI Mock Test
                </button>
                <button class="btn btn-secondary" onclick="showPage('page-builder')">
                    ‚úèÔ∏è Create Custom Test
                </button>
            </div>
        </div>

        <div class="container">
            <div id="history-section" class="hidden" style="margin-top: 40px;">
                <h2 style="margin-bottom: 20px; font-size: 1.8rem; font-weight: 700;">üìö Your Recent Tests</h2>
                <div id="history-list" class="history-grid"></div>
            </div>
        </div>
    </section>

    <!-- AI Setup Page -->
    <section id="page-setup" class="page container hidden">
        <div class="card" style="max-width: 800px; margin: 40px auto;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px;">
                <button class="btn btn-outline" onclick="showPage('page-home')">‚Üê Back</button>
                <h2 style="font-size: 2rem; font-weight: 700;">‚öôÔ∏è AI Test Configuration</h2>
            </div>

            <div class="form-group">
                <label>üë§ Candidate Name *</label>
                <input type="text" id="set-name" placeholder="Enter your full name" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>üìÇ Exam Category</label>
                    <select id="set-cat" onchange="loadExams()"></select>
                </div>
                <div class="form-group">
                    <label>üéì Target Exam</label>
                    <select id="set-exam" onchange="loadSubjects()"></select>
                </div>
            </div>

            <div class="form-group">
                <label>üìñ Subject</label>
                <select id="set-sub" onchange="loadChapters()"></select>
            </div>

            <div class="form-group">
                <label>üìë Topic / Chapter</label>
                <select id="set-chap"></select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>‚ùì Questions</label>
                    <select id="set-count">
                        <option value="5">5 Questions</option>
                        <option value="10" selected>10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                        <option value="25">25 Questions</option>
                        <option value="50">50 Questions</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‚è±Ô∏è Time (Minutes)</label>
                    <input type="number" id="set-time" value="15" min="1" max="180">
                </div>
                <div class="form-group">
                    <label>‚ûñ Negative Marking</label>
                    <select id="set-neg">
                        <option value="0">None</option>
                        <option value="0.25">0.25</option>
                        <option value="0.33" selected>0.33</option>
                        <option value="0.5">0.5</option>
                        <option value="1">1.0</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 20px; padding: 16px;" onclick="startAIGeneration()">
                üöÄ Generate AI Mock Test
            </button>
        </div>
    </section>

    <!-- Custom Builder Page -->
    <section id="page-builder" class="page container hidden">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="font-size: 2rem; font-weight: 700;">‚úèÔ∏è Custom Test Builder</h2>
                <button class="btn btn-outline" onclick="showPage('page-home')">Cancel</button>
            </div>

            <div class="form-group">
                <label>üìù Test Title</label>
                <input type="text" id="build-title" placeholder="E.g., My History Practice Test">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>‚è±Ô∏è Duration (Minutes)</label>
                    <input type="number" id="build-time" value="15" min="1">
                </div>
                <div class="form-group">
                    <label>‚ûñ Negative Marking</label>
                    <input type="number" id="build-neg" value="0.25" step="0.01" min="0">
                </div>
            </div>

            <div id="build-list" style="margin-top: 25px;"></div>

            <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-outline" onclick="addBuildItem()">‚ûï Add Question</button>
                <button class="btn btn-primary" onclick="launchCustom()">üöÄ Launch Test</button>
                <button class="btn btn-secondary" onclick="generateShareLink()">üîó Generate Share Link</button>
            </div>
        </div>
    </section>

    <!-- Share Modal -->
    <div id="share-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 600px; padding: 40px; text-align: center;">
            <h2 style="margin-bottom: 10px;">üéâ Share Link Generated!</h2>
            <p style="color: var(--text-muted); margin-bottom: 25px;">Copy and share this link with your students</p>
            
            <div style="background: var(--bg); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px dashed var(--primary);">
                <input type="text" id="share-url" readonly style="text-align: center; font-family: monospace; font-size: 0.9rem; background: transparent; border: none;">
            </div>

            <div id="share-mode-info" style="margin-bottom: 20px; padding: 12px; background: #fef3c7; border-radius: 8px; font-size: 0.85rem; text-align: left;">
                <strong>üìç Sharing Mode:</strong> <span id="share-mode-text"></span>
            </div>

            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="copyShareLink()">üìã Copy Link</button>
                <button class="btn btn-success" onclick="whatsappShare()">üì± WhatsApp Share</button>
                <button class="btn btn-outline" onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Test Page -->
    <section id="page-test" class="page hidden">
        <div class="test-header">
            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                <div class="test-info">
                    <div class="user-avatar" id="ui-initial">K</div>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1rem;" id="ui-user">Student</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);" id="ui-meta">Exam Name</div>
                    </div>
                </div>
                <div class="timer" id="timer">00:00</div>
                <button class="btn btn-danger" onclick="submitTest()">üèÅ Finish Test</button>
            </div>
        </div>

        <div class="container test-grid">
            <div>
                <div class="question-card fade-in">
                    <div class="question-header">
                        <span class="topic-badge" id="ui-topic">Topic</span>
                        <span class="question-counter" id="ui-q-count">Q1 of 10</span>
                    </div>
                    <div class="question-text" id="ui-q-text"></div>
                    <div id="ui-options"></div>
                    <textarea id="ui-rough" placeholder="üìù Write rough notes for this question..." style="margin-top: 25px; height: 100px; resize: vertical; font-size: 0.95rem;"></textarea>
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                    <button class="btn btn-outline" onclick="changeQ(-1)">‚¨ÖÔ∏è Previous</button>
                    <button class="btn btn-outline" style="color: var(--warning); border-color: var(--warning);" onclick="markQ()">üîñ Mark for Review</button>
                    <button class="btn btn-outline" style="color: var(--text-muted); border-color: var(--border);" onclick="clearAns()">üóëÔ∏è Clear Answer</button>
                    <button class="btn btn-primary" onclick="changeQ(1)">Save & Next ‚û°Ô∏è</button>
                </div>
            </div>

            <div class="palette-card card">
                <h3 style="font-size: 1.2rem; margin-bottom: 10px;">üéØ Question Palette</h3>
                <div class="palette" id="palette"></div>
                <div class="palette-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--success);"></div>
                        <span>Answered</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--warning);"></div>
                        <span>Marked</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fee2e2;"></div>
                        <span>Unanswered</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="border: 3px solid var(--primary);"></div>
                        <span>Current</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Result Page -->
    <section id="page-result" class="page container hidden">
        <div class="result-section">
            <div class="card" style="text-align: center; padding: 50px 30px;">
                <h1 style="font-size: 2.5rem; margin-bottom: 15px;">üèÜ Test Performance Report</h1>
                <p style="color: var(--text-muted); font-size: 1.1rem;">Here's how you performed!</p>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="res-score">0/0</div>
                        <div class="stat-label">Total Marks</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-value" id="res-acc">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-value" id="res-rank">#0</div>
                        <div class="stat-label">All India Rank</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-value" id="res-time">0m</div>
                        <div class="stat-label">Time Taken</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; text-align: left; margin-top: 30px;">
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">üí° Performance Analysis</h3>
                        <div id="res-tips" style="color: var(--text-main); line-height: 1.8;"></div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">üìä Leaderboard</h3>
                        <div id="res-leaderboard"></div>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="location.reload()">üîÑ New Test</button>
                    <button class="btn btn-success" onclick="downloadCertificate()">üìú Download Certificate</button>
                    <button class="btn btn-danger" onclick="resetApp()">üóëÔ∏è Reset All Data</button>
                </div>
            </div>

            <div style="margin-top: 40px;">
                <h2 style="font-size: 2rem; margin-bottom: 20px;">üìã Detailed Solutions</h2>
                <div id="res-review"></div>
            </div>
        </div>
    </section>

    <canvas id="cert-canvas" width="1200" height="800" style="display:none;"></canvas>

    <script>
        // ============================================
        // EXAM DATA - FULL LIST ADDED AS PER YOUR REQUEST
        // ============================================

        const EXAM_DATA = {
            "SSC EXAMS": {
                exams: ["SSC CGL", "SSC CHSL", "SSC CPO", "SSC MTS", "SSC GD", "SSC Stenographer", "SSC JE"],
                subjects: (exam) => {
                    if (exam === "SSC JE") {
                        return ["General Intelligence & Reasoning", "General Awareness", "Civil Engineering", "Electrical Engineering", "Mechanical Engineering"];
                    }
                    return ["Quantitative Aptitude", "General Intelligence & Reasoning", "English Language", "General Awareness"];
                }
            },
            "UPSC EXAMS": {
                exams: ["UPSC CSE (Prelims)", "UPSC CDS", "UPSC NDA", "UPSC CAPF", "UPSC IES/ESE", "UPSC CMS"],
                subjects: (exam) => {
                    if (exam === "UPSC CSE (Prelims)") {
                        return ["General Studies Paper I", "CSAT (Paper II)"];
                    }
                    if (exam === "UPSC CDS") {
                        return ["English", "General Knowledge", "Elementary Mathematics"];
                    }
                    if (exam === "UPSC NDA") {
                        return ["Mathematics", "General Ability Test"];
                    }
                    if (exam === "UPSC CAPF") {
                        return ["General Ability & Intelligence", "General Studies, Essay & Comprehension"];
                    }
                    if (exam === "UPSC CMS") {
                        return ["Paper I (General Medicine & Pediatrics)", "Paper II (Surgery, Gynaecology & Preventive Medicine)"];
                    }
                    if (exam === "UPSC IES/ESE") {
                        return ["Engineering Mathematics", "General Studies & Engineering Aptitude", "Civil Engineering", "Mechanical Engineering", "Electrical Engineering", "Electronics & Telecommunication"];
                    }
                    return ["General Studies", "CSAT"];
                }
            },
            "BANKING EXAMS": {
                exams: ["SBI PO", "IBPS PO", "SBI Clerk", "IBPS Clerk", "IBPS RRB PO", "IBPS RRB Clerk", "RBI Grade B", "NABARD Grade A"],
                subjects: (exam) => {
                    if (exam.includes("PO")) {
                        return ["Quantitative Aptitude", "Reasoning Ability", "English Language", "General Awareness", "Computer Awareness", "Descriptive English"];
                    }
                    if (exam.includes("Clerk")) {
                        return ["Quantitative Aptitude", "Reasoning Ability", "English Language", "General / Banking Awareness", "Computer Awareness"];
                    }
                    if (exam === "RBI Grade B") {
                        return ["General Awareness", "English Language", "Quantitative Aptitude", "Reasoning", "Finance & Management", "Economics", "Descriptive English"];
                    }
                    if (exam === "NABARD Grade A") {
                        return ["Reasoning", "Quantitative Aptitude", "English", "General Awareness", "Agriculture & Rural Development", "Economics & Social Issues"];
                    }
                    return ["Quantitative Aptitude", "Reasoning Ability", "English Language", "General Awareness"];
                }
            },
            "RAILWAY EXAMS": {
                exams: ["RRB NTPC", "RRB Group D", "RRB JE", "RRB ALP / Technician"],
                subjects: (exam) => {
                    if (exam === "RRB NTPC") {
                        return ["Mathematics", "General Intelligence & Reasoning", "General Awareness"];
                    }
                    if (exam === "RRB Group D") {
                        return ["Mathematics", "General Science", "General Intelligence & Reasoning", "General Awareness"];
                    }
                    if (exam === "RRB JE") {
                        return ["Mathematics", "General Intelligence & Reasoning", "General Awareness", "Technical Subject"];
                    }
                    if (exam === "RRB ALP / Technician") {
                        return ["Mathematics", "Reasoning", "General Science", "Technical Trade Knowledge"];
                    }
                    return ["Mathematics", "General Intelligence & Reasoning", "General Awareness"];
                }
            },
            "DEFENCE EXAMS": {
                exams: ["NDA & NA", "CDS", "AFCAT", "INET"],
                subjects: (exam) => {
                    if (exam === "NDA & NA") {
                        return ["Mathematics", "General Ability Test"];
                    }
                    if (exam === "CDS") {
                        return ["English", "General Knowledge", "Elementary Mathematics"];
                    }
                    if (exam === "AFCAT") {
                        return ["General Awareness", "Verbal Ability (English)", "Numerical Ability", "Reasoning", "Military Aptitude"];
                    }
                    if (exam === "INET") {
                        return ["Reasoning & Numerical Ability", "English", "General Awareness", "Naval Orientation"];
                    }
                    return ["General Awareness", "English", "Mathematics", "Reasoning"];
                }
            },
            "TEACHING EXAMS": {
                exams: ["CTET", "State TET", "DSSSB / KVS / NVS"],
                subjects: (exam) => {
                    if (exam === "CTET" || exam === "State TET") {
                        return ["Child Development & Pedagogy", "Language I", "Language II", "Mathematics", "Environmental Studies / Science / Social Studies"];
                    }
                    return ["General Awareness", "General Intelligence & Reasoning", "English Language", "Hindi Language", "Teaching Methodology", "Subject Concerned"];
                }
            },
            "STATE PSC EXAMS": {
                exams: ["UPPSC", "BPSC", "MPPSC", "State Police SI / Constable"],
                subjects: (exam) => {
                    if (exam.includes("PSC")) {
                        return ["General Studies", "Optional Subject"];
                    }
                    return ["General Knowledge", "Reasoning", "Quantitative Aptitude", "Current Affairs"];
                }
            },
            "OTHER GOVERNMENT EXAMS": {
                exams: ["EPFO", "ESIC", "LIC AAO / ADO", "SEBI Grade A", "AAI", "FCI"],
                subjects: (exam) => {
                    if (exam === "EPFO") return ["General English", "Quantitative Aptitude", "Reasoning", "General Awareness", "Labour Laws", "Industrial Relations"];
                    if (exam === "ESIC") return ["Reasoning", "Quantitative Aptitude", "English", "General Awareness", "Computer Knowledge"];
                    if (exam.includes("LIC")) return ["Reasoning", "Quantitative Aptitude", "English", "General Awareness", "Insurance Awareness"];
                    if (exam === "SEBI Grade A") return ["Reasoning", "Quantitative Aptitude", "English", "General Awareness", "Finance", "Management", "Economics", "Securities Market"];
                    if (exam === "AAI") return ["General Intelligence", "English", "Quantitative Aptitude", "General Awareness", "Aviation Knowledge"];
                    if (exam === "FCI") return ["Reasoning", "Quantitative Aptitude", "English", "General Awareness", "Management", "Agriculture"];
                    return ["General English", "Quantitative Aptitude", "Reasoning", "General Awareness"];
                }
            }
        };

        // ============================================
        // TOPICS - FULL DETAILED LIST ADDED
        // ============================================

        const TOPICS = {
            "Quantitative Aptitude": [
                "Number System", "Simplification & Approximation", "HCF & LCM", "Ratio & Proportion", "Percentage", "Average", "Profit & Loss", "Simple Interest", "Compound Interest", "Time & Work", "Pipes & Cisterns", "Time, Speed & Distance", "Trains", "Boats & Streams", "Mixture & Alligation", "Mensuration (2D)", "Mensuration (3D)", "Geometry", "Trigonometry", "Height & Distance", "Coordinate Geometry", "Probability", "Permutation & Combination", "Data Interpretation (Table, Bar Graph, Pie Chart, Line Graph)"
            ],
            "General Intelligence & Reasoning": [
                "Analogy", "Classification", "Series (Number / Alphabet)", "Coding-Decoding", "Blood Relations", "Direction Sense", "Order & Ranking", "Seating Arrangement (Linear, Circular)", "Puzzles", "Syllogism", "Inequality", "Venn Diagrams", "Statement & Conclusion", "Statement & Assumption", "Cause & Effect", "Decision Making", "Input-Output", "Logical Reasoning", "Non-Verbal Reasoning (Mirror Image, Water Image, Paper Folding, Figure Completion)"
            ],
            "English Language": [
                "Reading Comprehension", "Cloze Test", "Error Spotting", "Sentence Improvement", "Fill in the Blanks", "Para Jumbles", "Vocabulary (Synonyms, Antonyms, One Word Substitution, Idioms & Phrases)", "Active & Passive Voice", "Direct & Indirect Speech", "Tenses", "Articles", "Prepositions", "Conjunctions", "Spelling Correction"
            ],
            "General Awareness": [
                "History (Ancient India, Medieval India, Modern India, Freedom Struggle)", "Geography (Physical Geography, Indian Geography, World Geography, Rivers, Mountains, Climate, Soils)", "Polity (Constitution, Fundamental Rights, DPSP, Parliament, President & PM, Judiciary, Constitutional Bodies)", "Economy (Basic Economics, Indian Economy, GDP, Inflation, Budget, Taxation, Banking System)", "General Science (Physics, Chemistry, Biology)", "Current Affairs (National, International, Sports, Awards, Appointments, Schemes)"
            ],
            "General Science": {
                "Physics": ["Motion", "Laws of Motion", "Work, Power & Energy", "Gravitation", "Heat & Thermodynamics", "Sound", "Light", "Electricity", "Magnetism"],
                "Chemistry": ["Matter", "Atomic Structure", "Periodic Table", "Chemical Reactions", "Acids, Bases & Salts", "Metals & Non-Metals", "Carbon Compounds"],
                "Biology": ["Cell", "Human Body Systems", "Nutrition", "Respiration", "Reproduction", "Genetics", "Ecology", "Diseases"]
            },
            "Civil Engineering": [
                "Engineering Mathematics (Linear Algebra, Calculus, Differential Equations, Probability)", "Strength of Materials (Stress & Strain, Elastic Constants, Bending Stress, Torsion, Shear Force & Bending Moment, Columns)", "Structural Analysis (Determinate Structures, Indeterminate Structures, Trusses, Influence Lines)", "RCC (Working Stress Method, Limit State Method, Beams, Columns, Slabs, Footings)", "Steel Structures (Tension Members, Compression Members, Beams, Connections)", "Geotechnical Engineering (Soil Properties, Permeability, Consolidation, Shear Strength, Earth Pressure, Foundations)", "Surveying (Chain Survey, Compass Survey, Levelling, Theodolite, Tacheometry, Curves, Total Station & GPS)", "Environmental Engineering (Water Supply, Waste Water Engineering, Solid Waste, Air Pollution)", "Transportation Engineering (Highway Engineering, Traffic Engineering, Railway Engineering, Airport Engineering)", "Irrigation Engineering (Hydrology, Dams, Canals, Irrigation Methods)"
            ],
            "Mechanical Engineering": [
                "Engineering Mechanics", "Strength of Materials", "Theory of Machines", "Machine Design", "Fluid Mechanics", "Thermodynamics", "Heat Transfer", "IC Engines", "Power Plant", "Manufacturing Processes", "Industrial Engineering"
            ],
            "Electrical Engineering": [
                "Circuit Theory", "Electrical Machines", "Power Systems", "Control Systems", "Measurements", "Power Electronics", "Digital Electronics"
            ],
            "Electronics Engineering": [
                "Network Theory", "Analog Circuits", "Digital Electronics", "Signals & Systems", "Communication Systems", "Microprocessors", "Control Systems"
            ],
            "Child Development & Pedagogy": [
                "Growth & Development", "Learning Theories", "Intelligence", "Motivation", "Inclusive Education", "Teaching-Learning Process", "Assessment & Evaluation"
            ],
            "Teaching Methodology": [
                "Teaching Methods", "Lesson Planning", "Classroom Management", "Educational Psychology", "Assessment Techniques"
            ],
            "Banking & Financial Awareness": [
                "Banking Terminology", "RBI & Monetary Policy", "Financial Institutions", "Capital Market", "Money Market", "Budget & Economic Survey", "Current Banking Affairs", "Digital Banking", "Financial Inclusion"
            ]
            // You can add more specific topics for other subjects if needed later
        };

        const getTopicsForSubject = (subject) => {
            if (typeof TOPICS[subject] === 'object' && !Array.isArray(TOPICS[subject])) {
                // For subjects with sub-objects (e.g. General Science)
                return Object.keys(TOPICS[subject]).flatMap(key => TOPICS[subject][key]);
            }
            return TOPICS[subject] || ["General Concepts", "Basic Principles", "Advanced Topics", "Practice Set 1", "Practice Set 2"];
        };

        // ============================================
        // REST OF YOUR ORIGINAL SCRIPT (UNCHANGED)
        // ============================================

        let state = {
            q: [],
            ans: {},
            status: {},
            notes: {},
            cur: 0,
            meta: {},
            timer: null,
            timeLeft: 0,
            submitted: false
        };

        window.onload = () => {
            loadCategories();
            addBuildItem();
            loadHistory();
            checkSharedLink();
        };

        function loadCategories() {
            const el = document.getElementById('set-cat');
            el.innerHTML = "";
            Object.keys(EXAM_DATA).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                el.appendChild(opt);
            });
            loadExams();
        }

        window.loadExams = () => {
            const cat = document.getElementById('set-cat').value;
            const el = document.getElementById('set-exam');
            el.innerHTML = "";
            EXAM_DATA[cat].exams.forEach(exam => {
                const opt = document.createElement('option');
                opt.value = exam;
                opt.textContent = exam;
                el.appendChild(opt);
            });
            loadSubjects();
        };

        window.loadSubjects = () => {
            const cat = document.getElementById('set-cat').value;
            const exam = document.getElementById('set-exam').value;
            const el = document.getElementById('set-sub');
            el.innerHTML = "";
            const subjects = EXAM_DATA[cat].subjects(exam);
            subjects.forEach(sub => {
                const opt = document.createElement('option');
                opt.value = sub;
                opt.textContent = sub;
                el.appendChild(opt);
            });
            loadChapters();
        };

        window.loadChapters = () => {
            const sub = document.getElementById('set-sub').value;
            const el = document.getElementById('set-chap');
            el.innerHTML = "";
            const topics = getTopicsForSubject(sub);
            topics.forEach(topic => {
                const opt = document.createElement('option');
                opt.value = topic;
                opt.textContent = topic;
                el.appendChild(opt);
            });
        };

        window.showPage = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0, 0);
        };

        async function startAIGeneration() {
            const name = document.getElementById('set-name').value.trim();
            if (!name) {
                alert("‚ö†Ô∏è Please enter your name");
                return;
            }

            const exam = document.getElementById('set-exam').value;
            const sub = document.getElementById('set-sub').value;
            const chap = document.getElementById('set-chap').value;
            const count = parseInt(document.getElementById('set-count').value);
            const time = parseInt(document.getElementById('set-time').value);
            const negMark = parseFloat(document.getElementById('set-neg').value);

            toggleOverlay(true, `Generating ${count} Questions...`, "Groq AI is creating high-quality MCQs for you");

            const prompt = `You are an expert exam question setter for Indian Government Exams like SSC, UPSC, Banking etc. Generate exactly ${count} high-quality Multiple Choice Questions for:

**Topic/Chapter**: ${chap}
**Subject**: ${sub}
**Exam Level**: ${exam}

STRICT REQUIREMENTS - FOLLOW EXACTLY:
1. Each question must have exactly 4 options (A, B, C, D).
2. Provide detailed explanation (2-3 sentences) for the correct answer only.
3. Return ONLY a valid JSON array - NO extra text, NO markdown, NO code blocks, NO explanations outside the array.
4. JSON structure must be exactly this:

[
  {
    "q": "Clear question text here",
    "o": ["Option A text", "Option B text", "Option C text", "Option D text"],
    "a": 0,   // index of correct option: 0=A, 1=B, 2=C, 3=D
    "e": "Detailed explanation why this is correct and why others are wrong"
  }
]

Start your response directly with [ and end with ]. Nothing before or after.`;

            try {
                const GROQ_API_KEY = "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";

                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${GROQ_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "user", content: prompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 2500,
                        top_p: 0.9
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `Groq API error: ${response.status}`);
                }

                const data = await response.json();
                let content = data.choices?.[0]?.message?.content || "";

                content = content.trim()
                    .replace(/^```json\s*/i, '')
                    .replace(/```$/i, '')
                    .trim();

                const jsonStart = content.indexOf('[');
                const jsonEnd = content.lastIndexOf(']') + 1;
                if (jsonStart === -1 || jsonEnd <= jsonStart) {
                    throw new Error("No valid JSON array found in response");
                }

                const jsonStr = content.substring(jsonStart, jsonEnd);
                const qs = JSON.parse(jsonStr);

                if (!Array.isArray(qs) || qs.length !== count) {
                    throw new Error(`Expected ${count} questions, got ${qs.length || 'invalid'}`);
                }

                qs.forEach((q, idx) => {
                    if (!q.q || !Array.isArray(q.o) || q.o.length !== 4 || q.a === undefined || !q.e) {
                        throw new Error(`Question ${idx + 1} is incomplete`);
                    }
                    q.a = parseInt(q.a);
                    if (isNaN(q.a) || q.a < 0 || q.a > 3) q.a = 0;
                });

                toggleOverlay(false);
                initTest(qs, { name, exam, sub, topic: chap, time: time * 60, neg: negMark });

            } catch (e) {
                toggleOverlay(false);
                console.error("Groq Error:", e);
                let msg = "‚ùå Failed to generate test.\n\n" + e.message;

                if (e.message.includes("rate limit") || e.message.includes("429")) {
                    msg += "\n\nRate limit hit - wait 1-5 minutes and try again (free tier limit).";
                } else if (e.message.includes("invalid") || e.message.includes("authentication")) {
                    msg += "\n\nCheck your Groq API key - it might be invalid or expired.";
                }

                alert(msg);
            }
        }

        // ============================================
        // REMAINING ORIGINAL FUNCTIONS (UNCHANGED)
        // ============================================

        function addBuildItem() {
            const num = document.querySelectorAll('.build-item').length + 1;
            const div = document.createElement('div');
            div.className = 'card build-item';
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4>Question #${num}</h4>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.5rem; font-weight: bold;">√ó</button>
                </div>
                <div class="form-group">
                    <label>Question Text</label>
                    <textarea class="q-text" placeholder="Enter your question" style="height: 80px;"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Option A</label>
                        <input type="text" class="q-opt" placeholder="Option A">
                    </div>
                    <div class="form-group">
                        <label>Option B</label>
                        <input type="text" class="q-opt" placeholder="Option B">
                    </div>
                    <div class="form-group">
                        <label>Option C</label>
                        <input type="text" class="q-opt" placeholder="Option C">
                    </div>
                    <div class="form-group">
                        <label>Option D</label>
                        <input type="text" class="q-opt" placeholder="Option D">
                    </div>
                </div>
                <div class="form-group">
                    <label>Correct Answer</label>
                    <select class="q-ans">
                        <option value="0">A</option>
                        <option value="1">B</option>
                        <option value="2">C</option>
                        <option value="3">D</option>
                    </select>
                </div>
            `;
            document.getElementById('build-list').appendChild(div);
        }

        window.launchCustom = () => {
            const items = document.querySelectorAll('.build-item');
            if (items.length === 0) {
                alert("‚ö†Ô∏è Please add at least one question");
                return;
            }

            const qs = [];
            let valid = true;

            items.forEach((item, idx) => {
                const qText = item.querySelector('.q-text').value.trim();
                const opts = Array.from(item.querySelectorAll('.q-opt')).map(o => o.value.trim());
                const ans = parseInt(item.querySelector('.q-ans').value);

                if (!qText) { alert(`‚ö†Ô∏è Question #${idx + 1} text is empty`); valid = false; return; }
                if (opts.some(o => !o)) { alert(`‚ö†Ô∏è Question #${idx + 1} has empty options`); valid = false; return; }

                qs.push({
                    q: qText,
                    o: opts,
                    a: ans,
                    e: "Custom question - no explanation provided."
                });
            });

            if (!valid) return;

            const title = document.getElementById('build-title').value.trim() || "Custom Test";
            const time = parseInt(document.getElementById('build-time').value) * 60;
            const neg = parseFloat(document.getElementById('build-neg').value);

            initTest(qs, {
                name: "Student",
                exam: "Custom Test",
                sub: "User Created",
                topic: title,
                time,
                neg
            });
        };

        function initTest(qs, meta) {
            state = {
                q: qs,
                ans: {},
                status: {},
                notes: {},
                cur: 0,
                meta,
                timeLeft: meta.time,
                submitted: false
            };

            showPage('page-test');
            document.getElementById('ui-user').textContent = meta.name;
            document.getElementById('ui-initial').textContent = meta.name.charAt(0).toUpperCase();
            document.getElementById('ui-meta').textContent = `${meta.exam} | ${meta.topic}`;

            startTimer();
            renderQuestion();
            renderPalette();
        }

        function startTimer() {
            clearInterval(state.timer);
            state.timer = setInterval(() => {
                state.timeLeft = Math.max(0, state.timeLeft - 1);
                if (state.timeLeft <= 0) submitTest(true);
                updateTimer();
            }, 1000);
        }

        function updateTimer() {
            const m = Math.floor(state.timeLeft / 60);
            const s = state.timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function renderQuestion() {
            const q = state.q[state.cur];
            document.getElementById('ui-q-count').textContent = `Q${state.cur + 1} of ${state.q.length}`;
            document.getElementById('ui-topic').textContent = state.meta.topic;
            document.getElementById('ui-q-text').textContent = q.q;
            document.getElementById('ui-rough').value = state.notes[state.cur] || "";

            const optDiv = document.getElementById('ui-options');
            optDiv.innerHTML = "";

            q.o.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = 'option' + (state.ans[state.cur] === i ? ' selected' : '');
                div.innerHTML = `
                    <div class="option-label">${String.fromCharCode(65 + i)}</div>
                    <div style="flex: 1;">${opt}</div>
                `;
                div.onclick = () => selectOption(i);
                optDiv.appendChild(div);
            });

            document.getElementById('ui-rough').oninput = (e) => {
                state.notes[state.cur] = e.target.value;
            };
        }

        function selectOption(i) {
            state.ans[state.cur] = i;
            state.status[state.cur] = 'ans';
            renderQuestion();
            renderPalette();
        }

        window.clearAns = () => {
            delete state.ans[state.cur];
            delete state.status[state.cur];
            renderQuestion();
            renderPalette();
        };

        window.markQ = () => {
            state.status[state.cur] = 'mark';
            renderPalette();
        };

        window.changeQ = (dir) => {
            const next = state.cur + dir;
            if (next >= 0 && next < state.q.length) {
                state.cur = next;
                renderQuestion();
                renderPalette();
            }
        };

        function renderPalette() {
            const pal = document.getElementById('palette');
            pal.innerHTML = "";

            state.q.forEach((_, i) => {
                const btn = document.createElement('div');
                btn.className = 'palette-btn';
                
                if (i === state.cur) btn.classList.add('current');
                if (state.status[i] === 'ans') btn.classList.add('answered');
                if (state.status[i] === 'mark') btn.classList.add('marked');
                if (!state.status[i]) btn.classList.add('unanswered');

                btn.textContent = i + 1;
                btn.onclick = () => {
                    state.cur = i;
                    renderQuestion();
                    renderPalette();
                };
                pal.appendChild(btn);
            });
        }

        window.submitTest = (auto = false) => {
            if (state.submitted) return;
            if (!auto && !confirm("üèÅ Submit your test? You won't be able to change answers.")) return;
            
            state.submitted = true;
            clearInterval(state.timer);

            let correct = 0, wrong = 0, unattempted = 0;
            state.q.forEach((q, i) => {
                if (state.ans[i] === undefined) {
                    unattempted++;
                } else if (state.ans[i] === q.a) {
                    correct++;
                } else {
                    wrong++;
                }
            });

            const score = (correct * 1) - (wrong * state.meta.neg);
            const total = state.q.length;
            const attempted = correct + wrong;
            const accuracy = attempted > 0 ? Math.round((correct / attempted) * 100) : 0;
            const timeTaken = state.meta.time - state.timeLeft;

            showPage('page-result');

            document.getElementById('res-score').textContent = `${score.toFixed(2)}/${total}`;
            document.getElementById('res-acc').textContent = `${accuracy}%`;
            document.getElementById('res-time').textContent = `${Math.floor(timeTaken / 60)}m ${timeTaken % 60}s`;

            const rank = Math.max(1, Math.floor((total - score) * 10) + Math.floor(Math.random() * 30) + 1);
            document.getElementById('res-rank').textContent = `#${rank}`;

            renderTips(correct, wrong, unattempted, accuracy);
            renderLeaderboard(rank, score);
            renderReview();
            saveHistory(score, total, accuracy);
        };

        function renderTips(correct, wrong, unattempted, accuracy) {
            const tips = document.getElementById('res-tips');
            let msg = "";

            if (accuracy >= 80) {
                msg = `üéâ <strong>Outstanding Performance!</strong><br>You scored ${accuracy}% accuracy with ${correct} correct answers. You have excellent command over this topic!`;
            } else if (accuracy >= 60) {
                msg = `üëç <strong>Good Job!</strong><br>You got ${correct} questions right with ${accuracy}% accuracy. Review the ${wrong} incorrect answers to improve further.`;
            } else if (accuracy >= 40) {
                msg = `üìö <strong>Keep Practicing!</strong><br>You answered ${correct} correctly out of ${correct + wrong} attempted. Focus on understanding concepts thoroughly.`;
            } else {
                msg = `üí™ <strong>Don't Give Up!</strong><br>This is a learning opportunity. Review all solutions carefully and try more practice tests.`;
            }

            if (unattempted > 0) {
                msg += `<br><br>‚ö†Ô∏è You left ${unattempted} question(s) unanswered. Try to attempt all questions next time.`;
            }

            msg += `<br><br><strong>Next Steps:</strong> Review the detailed solutions below and note down key concepts for revision.`;

            tips.innerHTML = msg;
        }

        function renderLeaderboard(userRank, userScore) {
            const lb = document.getElementById('res-leaderboard');
            const leaderboard = [
                { name: "Topper Kumar", score: state.q.length - 0.25, rank: 1 },
                { name: "Priya Sharma", score: state.q.length - 1.0, rank: 2 },
                { name: "Rahul Singh", score: state.q.length - 1.5, rank: 3 },
                { name: state.meta.name + " (You)", score: userScore, rank: userRank, current: true }
            ].sort((a, b) => a.rank - b.rank).slice(0, 5);

            lb.innerHTML = "";
            leaderboard.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = `
                    padding: 12px;
                    margin-bottom: 8px;
                    border-radius: 8px;
                    display: flex;
                    justify-content: space-between;
                    ${item.current ? 'background: linear-gradient(135deg, #f5f3ff, #faf5ff); border: 2px solid var(--primary); font-weight: 700;' : 'background: var(--bg);'}
                `;
                div.innerHTML = `
                    <span>${item.current ? 'üéñÔ∏è ' : ''}#${item.rank} ${item.name}</span>
                    <span style="color: var(--primary);">${item.score.toFixed(2)}</span>
                `;
                lb.appendChild(div);
            });
        }

        function renderReview() {
            const review = document.getElementById('res-review');
            review.innerHTML = "";

            state.q.forEach((q, i) => {
                const userAns = state.ans[i];
                const isCorrect = userAns === q.a;
                const attempted = userAns !== undefined;

                const card = document.createElement('div');
                card.className = 'review-card ' + (!attempted ? 'skipped' : isCorrect ? 'correct' : 'wrong');
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <h4 style="flex: 1; font-size: 1.1rem; font-weight: 600;">Question ${i + 1}</h4>
                        <span style="padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; white-space: nowrap;
                            ${!attempted ? 'background: #f1f5f9; color: #64748b;' : 
                              isCorrect ? 'background: #d1fae5; color: #065f46;' : 
                              'background: #fee2e2; color: #991b1b;'}">
                            ${!attempted ? '‚äò NOT ATTEMPTED' : isCorrect ? '‚úì CORRECT' : '‚úó WRONG'}
                        </span>
                    </div>
                    
                    <p style="font-size: 1.05rem; margin-bottom: 20px; line-height: 1.7; font-weight: 500;">${q.q}</p>
                    
                    <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                        ${q.o.map((opt, idx) => `
                            <div style="padding: 14px 16px; border-radius: 10px; display: flex; align-items: center; gap: 12px;
                                ${idx === q.a ? 'background: #d1fae5; border: 2px solid #10b981;' : 
                                  idx === userAns && idx !== q.a ? 'background: #fee2e2; border: 2px solid #ef4444;' : 
                                  'background: #f8fafc; border: 1px solid #e2e8f0;'}">
                                <strong style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.5);">
                                    ${String.fromCharCode(65 + idx)}
                                </strong>
                                <span style="flex: 1;">${opt}</span>
                                ${idx === q.a ? '<span style="color: #10b981; font-weight: 700;">‚úì Correct</span>' : ''}
                                ${idx === userAns && idx !== q.a ? '<span style="color: #ef4444; font-weight: 700;">‚úó Your Answer</span>' : ''}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 18px; border-radius: 10px; border-left: 4px solid #0ea5e9;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 1.2rem;">üí°</span>
                            <strong style="color: #0369a1; font-size: 1rem;">Explanation:</strong>
                        </div>
                        <p style="color: #0c4a6e; line-height: 1.7; margin-left: 32px;">${q.e}</p>
                    </div>
                    
                    ${state.notes[i] ? `
                        <div style="margin-top: 15px; padding: 12px 16px; background: #fef3c7; border-radius: 8px; border-left: 3px solid #f59e0b;">
                            <strong style="color: #92400e; font-size: 0.9rem;">üìù Your Notes:</strong>
                            <p style="color: #78350f; margin-top: 5px; font-size: 0.9rem;">${state.notes[i]}</p>
                        </div>
                    ` : ''}
                `;
                
                review.appendChild(card);
            });
        }

        function saveHistory(score, total, accuracy) {
            const history = JSON.parse(localStorage.getItem('test_history') || '[]');
            history.unshift({
                topic: state.meta.topic,
                exam: state.meta.exam,
                subject: state.meta.sub,
                score: score.toFixed(2),
                total,
                accuracy: accuracy + '%',
                date: new Date().toLocaleDateString('en-IN'),
                timestamp: Date.now()
            });
            localStorage.setItem('test_history', JSON.stringify(history.slice(0, 20)));
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('test_history') || '[]');
            if (history.length === 0) return;

            document.getElementById('history-section').classList.remove('hidden');
            const list = document.getElementById('history-list');
            list.innerHTML = "";

            history.forEach(item => {
                const card = document.createElement('div');
                card.className = 'history-card';
                card.innerHTML = `
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">üìÖ ${item.date}</div>
                    <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 6px;">${item.topic}</h3>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 12px;">${item.exam} ‚Ä¢ ${item.subject}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.4rem; font-weight: 800; color: var(--primary);">${item.score}/${item.total}</span>
                        <span style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 5px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                            ${item.accuracy}
                        </span>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        window.downloadCertificate = () => {
            const canvas = document.getElementById('cert-canvas');
            const ctx = canvas.getContext('2d');

            // Background
            const gradient = ctx.createLinearGradient(0, 0, 1200, 800);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1200, 800);

            // Border
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 20;
            ctx.strokeRect(40, 40, 1120, 720);

            // Inner border
            ctx.strokeStyle = '#fbbf24';
            ctx.lineWidth = 5;
            ctx.strokeRect(60, 60, 1080, 680);

            // Title
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 60px Inter, Arial';
            ctx.textAlign = 'center';
            ctx.fillText('CERTIFICATE OF ACHIEVEMENT', 600, 150);

            // Decorative line
            ctx.beginPath();
            ctx.moveTo(300, 180);
            ctx.lineTo(900, 180);
            ctx.strokeStyle = '#fbbf24';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Body text
            ctx.fillStyle = '#ffffff';
            ctx.font = '28px Inter, Arial';
            ctx.fillText('This is proudly presented to', 600, 250);

            ctx.font = 'bold 56px Inter, Arial';
            ctx.fillStyle = '#fbbf24';
            ctx.fillText(state.meta.name.toUpperCase(), 600, 330);

            ctx.fillStyle = '#ffffff';
            ctx.font = '26px Inter, Arial';
            ctx.fillText(`for successfully completing the ${state.meta.topic} Mock Test`, 600, 390);
            ctx.fillText(`under ${state.meta.exam} preparation`, 600, 430);

            // Score details
            ctx.font = 'bold 32px Inter, Arial';
            ctx.fillText(`Score: ${document.getElementById('res-score').textContent}`, 600, 510);
            
            ctx.font = '28px Inter, Arial';
            ctx.fillText(`Accuracy: ${document.getElementById('res-acc').textContent} | Rank: ${document.getElementById('res-rank').textContent}`, 600, 560);

            // Date
            ctx.font = '22px Inter, Arial';
            ctx.fillStyle = '#e0e0e0';
            ctx.fillText(`Date of Issue: ${new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}`, 600, 630);

            // Signature
            ctx.fillStyle = '#fbbf24';
            ctx.font = 'italic 32px Inter, Arial';
            ctx.fillText('Kamal', 600, 700);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = '18px Inter, Arial';
            ctx.fillText('Founder & Creator, Mock Test Maker Pro', 600, 730);

            // Download
            const link = document.createElement('a');
            link.download = `Certificate_${state.meta.name.replace(/\s+/g, '_')}_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        };

        window.resetApp = () => {
            if (confirm('‚ö†Ô∏è This will permanently delete all your test history and progress. Are you absolutely sure?')) {
                if (confirm('üö® Final confirmation: Delete everything?')) {
                    localStorage.clear();
                    alert('‚úÖ All data has been reset!');
                    location.reload();
                }
            }
        };

        function toggleOverlay(show, title = '', text = '') {
            const overlay = document.getElementById('overlay');
            if (show) {
                document.getElementById('overlay-title').textContent = title;
                document.getElementById('overlay-text').textContent = text;
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        const ENABLE_ONLINE_SHARING = true;
        const JSONBIN_API_KEY = "$2a$10$zZLMiZYocl4Y1Ehmj2CpwesTwhwuSdxfVZRcln0MX2NF61fqyFK0y";

        window.generateShareLink = async () => {
            const items = document.querySelectorAll('.build-item');
            if (items.length === 0) {
                alert("‚ö†Ô∏è Please add at least one question before generating share link");
                return;
            }

            const qs = [];
            let valid = true;

            items.forEach((item, idx) => {
                const qText = item.querySelector('.q-text').value.trim();
                const opts = Array.from(item.querySelectorAll('.q-opt')).map(o => o.value.trim());
                const ans = parseInt(item.querySelector('.q-ans').value);

                if (!qText) {
                    alert(`‚ö†Ô∏è Question #${idx + 1} text is empty`);
                    valid = false;
                    return;
                }

                if (opts.some(o => !o)) {
                    alert(`‚ö†Ô∏è Question #${idx + 1} has empty options`);
                    valid = false;
                    return;
                }

                qs.push({
                    q: qText,
                    o: opts,
                    a: ans,
                    e: "Custom question - no explanation provided."
                });
            });

            if (!valid) return;

            const title = document.getElementById('build-title').value.trim() || "Custom Test";
            const time = parseInt(document.getElementById('build-time').value);
            const neg = parseFloat(document.getElementById('build-neg').value);

            const testData = {
                qs,
                meta: {
                    title,
                    time: time * 60,
                    neg
                }
            };

            if (ENABLE_ONLINE_SHARING && JSONBIN_API_KEY) {
                try {
                    toggleOverlay(true, "Generating Online Share Link...", "Uploading test to cloud storage");
                    
                    const response = await fetch('https://api.jsonbin.io/v3/b', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY,
                            'X-Bin-Private': 'false'
                        },
                        body: JSON.stringify(testData)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const binId = data.metadata.id;
                        const shareUrl = `${window.location.origin}${window.location.pathname}?sharedOnlineTest=${binId}`;
                        
                        document.getElementById('share-url').value = shareUrl;
                        document.getElementById('share-mode-text').innerHTML = `
                            <span style="color: #059669;">‚úÖ Online Mode</span> - Anyone can open this link on any device!
                        `;
                        document.getElementById('share-modal').classList.remove('hidden');
                        toggleOverlay(false);
                        return;
                    }
                } catch (error) {
                    console.error("Online sharing failed:", error);
                }
            }

            const testId = `KAMAL-${Math.floor(Math.random() * 900000) + 100000}`;
            localStorage.setItem(`shared_test_${testId}`, JSON.stringify(testData));

            const shareUrl = `${window.location.origin}${window.location.pathname}?sharedTest=${testId}`;
            
            document.getElementById('share-url').value = shareUrl;
            document.getElementById('share-mode-text').innerHTML = `
                <span style="color: #d97706;">‚ö†Ô∏è Local Mode</span> - This link works only on the same browser/device. 
                ${!ENABLE_ONLINE_SHARING ? '<br>Enable online sharing for universal links.' : ''}
            `;
            document.getElementById('share-modal').classList.remove('hidden');
        };

        window.copyShareLink = () => {
            const input = document.getElementById('share-url');
            input.select();
            input.setSelectionRange(0, 99999);
            
            try {
                navigator.clipboard.writeText(input.value);
                alert("‚úÖ Link copied to clipboard!");
            } catch (err) {
                document.execCommand('copy');
                alert("‚úÖ Link copied!");
            }
        };

        window.whatsappShare = () => {
            const url = document.getElementById('share-url').value;
            const title = document.getElementById('build-title').value.trim() || "Custom Test";
            const message = `üìö Attempt this Mock Test: *${title}*\n\n${url}\n\n‚úÖ Created using Mock Test Maker Pro`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        };

        window.closeShareModal = () => {
            document.getElementById('share-modal').classList.add('hidden');
        };

        async function checkSharedLink() {
            const urlParams = new URLSearchParams(window.location.search);
            
            const onlineTestId = urlParams.get('sharedOnlineTest');
            if (onlineTestId) {
                toggleOverlay(true, "Loading Shared Test...", "Fetching test from cloud storage");
                
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${onlineTestId}/latest`, {
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY || '$2a$10$placeholder'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const testData = data.record;
                        
                        toggleOverlay(false);
                        initTest(testData.qs, {
                            name: "Student",
                            exam: "Shared Test",
                            sub: "Custom",
                            topic: testData.meta.title,
                            time: testData.meta.time,
                            neg: testData.meta.neg
                        });
                        return;
                    } else {
                        throw new Error("Failed to load test");
                    }
                } catch (error) {
                    toggleOverlay(false);
                    alert("‚ùå Failed to load online shared test. The link may be invalid or expired.");
                    return;
                }
            }

            const localTestId = urlParams.get('sharedTest');
            if (localTestId) {
                const testData = localStorage.getItem(`shared_test_${localTestId}`);
                
                if (testData) {
                    const parsed = JSON.parse(testData);
                    const studentName = prompt("üë§ Enter your name to start the test:", "Student");
                    if (!studentName) return;
                    
                    initTest(parsed.qs, {
                        name: studentName,
                        exam: "Shared Test",
                        sub: "Custom",
                        topic: parsed.meta.title,
                        time: parsed.meta.time,
                        neg: parsed.meta.neg
                    });
                } else {
                    alert(`‚ùå Test not found on this device.\n\nTest ID: ${localTestId}\n\nThis share link works only on the same browser/device in offline mode.`);
                }
            }
        }
    </script>
</body>
</html>
